import requests
import hashlib
import hmac
from urllib.parse import urlencode

class PayFastService:
    def __init__(self):
        self.merchant_id = os.getenv('PAYFAST_MERCHANT_ID')
        self.merchant_key = os.getenv('PAYFAST_MERCHANT_KEY')
        self.base_url = "https://www.payfast.co.za/eng/process"
        
    def generate_signature(self, data):
        # Generate PayFast signature
        param_string = urlencode(data)
        return hmac.new(
            self.merchant_key.encode('utf-8'),
            param_string.encode('utf-8'),
            hashlib.md5
        ).hexdigest()
    
    def create_payment(self, amount, item_name, return_url, cancel_url):
        data = {
            'merchant_id': self.merchant_id,
            'merchant_key': self.merchant_key,
            'amount': str(amount),
            'item_name': item_name,
            'return_url': return_url,
            'cancel_url': cancel_url,
        }
        
        data['signature'] = self.generate_signature(data)
        return f"{self.base_url}?{urlencode(data)}"
